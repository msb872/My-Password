<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>مدیریت رمز عبور</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body {
      direction: rtl;
      font-family: "Vazir", Tahoma, sans-serif;
      background: linear-gradient(to bottom, #e6ecf3, #f7f9fb);
      padding: 30px;
    }

    main {
      background: white;
      padding: 25px 30px 35px;
      border-radius: 20px;
      max-width: 1000px;
      margin: auto;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.08);
    }

    h2 {
      text-align: center;
      margin-bottom: 16px;
      color: #2c3e50;
      font-size: 1.7rem;
      font-weight: bold;
    }

    #welcomeMessage {
      text-align: center;
      margin-bottom: 25px;
      color: #34495e;
      font-size: 1.1rem;
      line-height: 1.5;
    }

    .row {
      display: flex;
      gap: 14px;
      margin-bottom: 14px;
      flex-wrap: wrap;
      align-items: center;
    }

    .row > div {
      flex: 1;
      min-width: 140px;
    }

    input[type="text"],
    input[type="number"],
    button {
      font-family: inherit;
      font-size: 1rem;
      padding: 9px 11px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
    }

    input[type="number"] {
      max-width: 80px;
      text-align: center;
    }

    button {
      background-color: #3498db;
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      transition: all 0.25s ease;
    }

    button:hover {
      background-color: #2980b9;
      transform: scale(1.02);
      box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 10px;
      text-align: center;
      vertical-align: middle;
    }

    th {
      background: #f0f3f7;
      color: #333;
    }

    .actions {
      display: flex;
      justify-content: center;
      gap: 8px;
    }

    .actions button {
      background: none;
      border: none;
      font-size: 1.3em;
      cursor: pointer;
      color: #3498db;
      padding: 5px 8px;
      border-radius: 6px;
      transition: background-color 0.2s;
    }

    .actions button:hover {
      background-color: #eaf3fb;
    }

    .password-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .password-cell span {
      cursor: pointer;
      direction: ltr;
      user-select: all;
      padding: 6px 10px;
      border-radius: 8px;
      background: #f8f8f8;
      font-family: monospace;
      min-width: 100px;
      text-align: center;
      border: 1px solid #d3d3d3;
    }

    .strength {
      height: 10px;
      background: #ddd;
      border-radius: 6px;
      margin-top: 8px;
      overflow: hidden;
      position: relative;
    }

    .strength div {
      height: 100%;
      transition: width 0.3s ease;
      border-radius: 6px;
    }

    .green { background-color: #2ecc71; }
    .orange { background-color: #f39c12; }
    .red { background-color: #e74c3c; }

    #strengthText {
      margin-top: 6px;
      font-weight: bold;
      font-size: 0.9rem;
      color: #555;
      height: 22px;
      user-select: none;
      text-align: center;
      font-family: Tahoma, sans-serif;
    }

    #searchInput {
      margin-bottom: 15px;
      padding: 10px 12px;
      font-size: 1rem;
      border: 1px solid #aaa;
      border-radius: 8px;
      width: 100%;
      box-sizing: border-box;
    }

    label.checkbox-label {
      width: auto;
      padding: 0 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-weight: normal;
      color: #444;
      font-size: 0.95rem;
    }

    label.checkbox-label input {
      cursor: pointer;
    }

    .options-row {
      gap: 15px;
      justify-content: flex-start;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    .buttons-row {
      gap: 14px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 20px;
    }

  </style>
</head>
<body>
<main>
  <h2>مدیریت رمز عبور</h2>

  <div id="welcomeMessage">
    <p>به برنامه <strong>مدیریت رمز عبور</strong> خوش آمدید! این برنامه به شما کمک می‌کند تا رمزهای عبور خود را به آسانی تولید، ذخیره و مدیریت کنید.</p>
    <p>سازنده برنامه: <strong>مصیب خانی</strong></p>
  </div>

  <div class="row">
    <div style="max-width: 160px; display: flex; align-items: center; gap: 6px; margin-left: 10px;">
      <label for="pwdLength" style="white-space: nowrap;">تعداد ارقام رمز:</label>
      <input type="number" id="pwdLength" placeholder="12" min="6" max="64" value="12" />
    </div>
    <div><input type="text" id="purpose" placeholder="توضیح (مثلاً ایمیل)" /></div>
    <div><input type="text" id="category" placeholder="دسته‌بندی" /></div>
    <div style="flex: 1.5;">
      <input type="text" id="password" placeholder="رمز عبور" oninput="updateStrength()" autocomplete="off" />
    </div>
  </div>

  <div style="margin-top: 8px;">
    <div class="strength"><div id="strengthBar" style="width:0;"></div></div>
    <div id="strengthText"></div>
  </div>

  <div class="row options-row" style="margin-bottom: 20px;">
    <label class="checkbox-label"><input type="checkbox" id="useLower" checked /> حروف کوچک</label>
    <label class="checkbox-label"><input type="checkbox" id="useUpper" checked /> حروف بزرگ</label>
    <label class="checkbox-label"><input type="checkbox" id="useNumbers" checked /> اعداد</label>
    <label class="checkbox-label"><input type="checkbox" id="useSymbols" checked /> نمادها</label>
  </div>

  <div class="row buttons-row">
    <button onclick="addItem()">➕ افزودن</button>
    <button onclick="generatePassword()">🔐 تولید رمز قوی</button>
    <button onclick="generateFromInput()">✍️ تولید از متن</button>
    <button onclick="saveToFile()">💾 ذخیره رمزها</button>
    <button onclick="loadFromFile()">📂 بارگذاری</button>
  </div>

  <input id="searchInput" type="text" placeholder="جستجو در توضیح، دسته‌بندی و رمز..." oninput="renderTable()" />

  <table>
    <thead>
      <tr>
        <th>توضیح</th>
        <th>دسته‌بندی</th>
        <th>رمز عبور</th>
        <th>تاریخ</th>
        <th>عملیات</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <input type="file" id="fileInput" style="display:none" />
</main>

<script>
  const list = [];
  let editingIndex = null;

  function updateStrength() {
    const val = document.getElementById("password").value;
    const bar = document.getElementById("strengthBar");
    const text = document.getElementById("strengthText");

    let strength = 0;
    if (val.length >= 8) strength++;
    if (/[A-Z]/.test(val)) strength++;
    if (/[0-9]/.test(val)) strength++;
    if (/[^A-Za-z0-9]/.test(val)) strength++;

    const width = (strength / 4) * 100;
    bar.style.width = width + "%";

    let colorClass = "red";
    let strengthText = "ضعیف";

    if (strength >= 3) {
      colorClass = "green";
      strengthText = "قوی";
    } else if (strength === 2) {
      colorClass = "orange";
      strengthText = "متوسط";
    }

    bar.className = colorClass;
    text.textContent = strengthText;
    text.style.color = getComputedStyle(bar).backgroundColor;
  }

  function addItem() {
    const purpose = document.getElementById("purpose").value.trim();
    const category = document.getElementById("category").value.trim();
    const password = document.getElementById("password").value.trim();
    if (!purpose || !password) return alert("توضیح و رمز الزامی است");

    list.push({ purpose, category, password, createdAt: new Date().toISOString(), visible: false });
    renderTable();
    document.getElementById("purpose").value = "";
    document.getElementById("category").value = "";
    document.getElementById("password").value = "";
    updateStrength();
  }

  function renderTable() {
    const body = document.getElementById("tableBody");
    const filter = document.getElementById("searchInput").value.trim().toLowerCase();
    body.innerHTML = "";

    list.forEach((item, i) => {
      if (
        item.purpose.toLowerCase().includes(filter) ||
        item.category.toLowerCase().includes(filter) ||
        item.password.toLowerCase().includes(filter)
      ) {
        const tr = document.createElement("tr");
        if (editingIndex === i) {
          tr.innerHTML = `
            <td><input type="text" id="edit-purpose-${i}" value="${item.purpose}" /></td>
            <td><input type="text" id="edit-category-${i}" value="${item.category}" /></td>
            <td><input type="text" id="edit-password-${i}" value="${item.password}" style="font-family: monospace; direction: ltr;" /></td>
            <td>${new Date(item.createdAt).toLocaleDateString("fa-IR")}</td>
            <td class="actions">
              <button onclick="saveEdit(${i})" title="ذخیره">💾</button>
              <button onclick="cancelEdit()" title="لغو">✖️</button>
            </td>
          `;
        } else {
          const pwdDisplay = item.visible ? item.password : "*".repeat(item.password.length);
          const pwdId = `pwd-${i}`;
          tr.innerHTML = `
            <td>${item.purpose}</td>
            <td>${item.category}</td>
            <td class="password-cell">
              <span onclick="copyPassword('${pwdId}')" id="${pwdId}" title="کلیک برای کپی">${pwdDisplay}</span>
              <button onclick="togglePwd(${i})" title="نمایش/مخفی">👁️</button>
            </td>
            <td>${new Date(item.createdAt).toLocaleDateString("fa-IR")}</td>
            <td class="actions">
              <button onclick="startEdit(${i})" title="ویرایش">✏️</button>
              <button onclick="deleteItem(${i})" title="حذف">🗑️</button>
            </td>
          `;
        }
        body.appendChild(tr);
      }
    });
  }

  function startEdit(i) {
    editingIndex = i;
    renderTable();
  }

  function cancelEdit() {
    editingIndex = null;
    renderTable();
  }

  function saveEdit(i) {
    const p = document.getElementById(`edit-purpose-${i}`).value.trim();
    const c = document.getElementById(`edit-category-${i}`).value.trim();
    const pw = document.getElementById(`edit-password-${i}`).value.trim();
    if (!p || !pw) {
      alert("توضیح و رمز الزامی است");
      return;
    }
    list[i].purpose = p;
    list[i].category = c;
    list[i].password = pw;
    list[i].visible = false;
    editingIndex = null;
    renderTable();
  }

  function deleteItem(i) {
    if (confirm("آیا مطمئن هستید؟")) {
      if (editingIndex === i) editingIndex = null;
      list.splice(i, 1);
      renderTable();
    }
  }

  function togglePwd(index) {
    list[index].visible = !list[index].visible;
    renderTable();
  }

  function copyPassword(id) {
    const pwd = document.getElementById(id).textContent;
    navigator.clipboard.writeText(pwd).then(() => alert("رمز کپی شد!"));
  }

  function generatePassword() {
    const len = parseInt(document.getElementById("pwdLength").value) || 12;
    if(len < 6 || len > 64) {
      alert("تعداد رقم باید بین 6 تا 64 باشد.");
      return;
    }
    const useLower = document.getElementById("useLower").checked;
    const useUpper = document.getElementById("useUpper").checked;
    const useNumbers = document.getElementById("useNumbers").checked;
    const useSymbols = document.getElementById("useSymbols").checked;

    let chars = "";
    if(useLower) chars += "abcdefghijklmnopqrstuvwxyz";
    if(useUpper) chars += "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    if(useNumbers) chars += "0123456789";
    if(useSymbols) chars += "!@#$%^&*()_+{}[]|:;,.<>?";

    if(chars.length === 0) {
      alert("لطفا حداقل یک گزینه برای تولید رمز انتخاب کنید.");
      return;
    }

    let pwd = "";
    for (let i = 0; i < len; i++) {
      pwd += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById("password").value = pwd;
    updateStrength();
  }

  function generateFromInput() {
    const base = prompt("یک عبارت وارد کنید:");
    if (!base) return;

    const lower = "abcdefghijklmnopqrstuvwxyz";
    const upper = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const numbers = "0123456789";
    const symbols = "!@#$%^&*()-_=+[]{}<>?";

    let pwd = "";

    for (let i = 0; i < base.length; i++) {
      let ch = base[i];
      const code = ch.charCodeAt(0);

      if (lower.includes(ch.toLowerCase())) {
        // حروف الفبا
        if (Math.random() < 0.5) {
          // 50٪ بزرگ شود
          ch = upper[lower.indexOf(ch.toLowerCase())];
        } else {
          ch = lower[lower.indexOf(ch.toLowerCase())];
        }
        // 10٪ احتمال جایگزینی با نماد مرتبط یا عدد
        if (Math.random() < 0.1) {
          const symbolOrNum = Math.random() < 0.5 ? symbols : numbers;
          ch = symbolOrNum[Math.floor(Math.random() * symbolOrNum.length)];
        }
      } else if (numbers.includes(ch)) {
        // اگر عدد است، 20٪ احتمال تبدیل به نماد یا حرف
        if (Math.random() < 0.2) {
          const choice = Math.random();
          if (choice < 0.5) {
            ch = symbols[Math.floor(Math.random() * symbols.length)];
          } else {
            ch = lower[Math.floor(Math.random() * lower.length)];
          }
        }
        // در غیر اینصورت عدد همان عدد باقی می‌ماند
      } else {
        // اگر نماد یا چیز دیگر است، احتمال کمی تبدیل به حروف یا نماد جدید
        if (Math.random() < 0.3) {
          const choices = lower + upper + numbers + symbols;
          ch = choices[Math.floor(Math.random() * choices.length)];
        }
      }

      pwd += ch;
    }

    // اگر طول رمز کمتر از 12 بود، تا 12 کاملش کن (با اضافه کردن حروف/اعداد/نماد)
    while (pwd.length < 12) {
      const choices = lower + upper + numbers + symbols;
      pwd += choices[Math.floor(Math.random() * choices.length)];
    }

    document.getElementById("password").value = pwd;
    updateStrength();
  }

  function saveToFile() {
    const key = prompt("رمز فایل:");
    if (!key) return;
    const data = CryptoJS.AES.encrypt(JSON.stringify(list), key).toString();
    const blob = new Blob([data], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "passwords.enc.txt";
    a.click();
    URL.revokeObjectURL(url);
  }

  function loadFromFile() {
    document.getElementById("fileInput").click();
  }

  document.getElementById("fileInput").onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const key = prompt("رمز فایل را وارد کنید:");
      if (!key) return;
      try {
        const decrypted = CryptoJS.AES.decrypt(e.target.result, key).toString(CryptoJS.enc.Utf8);
        const parsed = JSON.parse(decrypted);
        if (Array.isArray(parsed)) {
          list.length = 0;
          parsed.forEach(item => {
            item.visible = false;
            list.push(item);
          });
          editingIndex = null;
          renderTable();
        } else {
          alert("فایل نامعتبر است.");
        }
      } catch {
        alert("خطا در رمز یا فرمت فایل.");
      }
    };
    reader.readAsText(file);
  };

  renderTable();
  updateStrength();
</script>
</body>
</html>
